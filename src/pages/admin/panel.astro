---
import { redirect } from 'astro:middleware';
import fs from 'fs';
import path from 'path';

export async function get({ request }) {
  const cookies = request.headers.get('cookie') || '';
  const isAuthenticated = cookies.includes('auth=true');

  if (!isAuthenticated) {
    return redirect('/admin/login');
  }
}

export async function post({ request }) {
  const formData = await request.formData();
  const title = formData.get('title');
  const image = formData.get('image');
  const tags = formData.get('tags');
  const description = formData.get('description');
  const content = formData.get('content');
  const slug = title.toLowerCase().replace(/ /g, '-');
  const pubDate = new Date().toISOString();

  const newPost = {
    title,
    image,
    tags: tags.split(',').map(tag => tag.trim()),
    description,
    pubDate,
    body: content,
  };

  const filePath = path.join('src', 'content', 'blog', `${slug}.md`);
  fs.writeFileSync(filePath, `---
title: "${title}"
image: "${image}"
tags: ${JSON.stringify(newPost.tags)}
description: "${description}"
pubDate: "${pubDate}"
---

${content}`);

  return {
    body: 'Blog post uploaded successfully',
  };
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
</head>
<body>
  <h1>Admin Panel</h1>
  <form method="POST">
    <label for="title">Title:</label>
    <input type="text" id="title" name="title" required>
    <br>
    <label for="image">Image URL:</label>
    <input type="text" id="image" name="image" required>
    <br>
    <label for="tags">Tags (comma separated):</label>
    <input type="text" id="tags" name="tags" required>
    <br>
    <label for="description">Description:</label>
    <textarea id="description" name="description" required></textarea>
    <br>
    <label for="content">Content:</label>
    <textarea id="content" name="content" required></textarea>
    <br>
    <button type="submit">Upload Blog Post</button>
  </form>
</body>
</html>